#include <EEPROM.h>
#include <ros.h>
#include <std_msgs/String.h>      ///MODEFIE
#include <Servo.h>
#include <Arduino.h>

ros::NodeHandle nh;
Servo doorservo;

const int passwordAddress = 0; // EEPROM address to store password

int storedPassword =123 ;

volatile bool receivedInterrupt = false; // Flag to indicate interrupt received
volatile bool passwordMatched = false; // Flag to indicate password matched
#define doorServPin 3
int pos2 = 0;       //detrmein te pos of the door servo 

int entered_pass; //variable used to store in it the data that recevied from python node

void setup()
{
      EEPROM.write( passwordAddress , storedPassword); //store in eeprom
  

  nh.initNode();
  nh.subscribe("password_topic", &passwordCallback); // sub subscrieb on the password_topic topic

  // Configuring servo and interrupt
  doorservo.attach(doorServoPin);
  attachInterrupt(digitalPinToInterrupt(doorServoPin), servoInterrupt, CHANGE); //use interuppt to open room door
}

void loop()
{
  if(receivedInterrupt) //flage used to check if intruppt is start
  {
    receivedInterrupt = false; //rest flage 

    if (passwordMatched) //flage used to check the enter password is the same or not
    {
      doorservo_on(); //func used to open the door servo
    }
    else
    {
      nh.loginfo("Invalid password!"); //send to thise node terminal  Invalid password 
    }

    // Reset flags
    passwordMatched = false;
  }

  nh.spinOnce();
}

void passwordCallback(const std_msgs::String& msg)
{
  // store the entered password 
  entered_pass = msg.data;
}

void servoInterrupt()
{
  // check if entered passwored matched 
  
    if (entered_pass == storedPassword)
    {
      passwordMatched = true; // Set flag to indicate password matched
    }
  

  receivedInterrupt = true; // Set flag to indicate interrupt received
}

 doorservo_on()
{
  for (pos2 = 0; pos2 <= 90; pos2 += 1)
  {
    doorservo.write(pos2);
    delay(2);
  }
  delay(100);
}
